#!/bin/bash
set -euo pipefail

python=@PYTHON_EXECUTABLE@

# Run ABC rejection
echo "Running ABC rejection"
"@PROJECT_BINARY_DIR@/src/pakman" serial rejection \
    --number-accept=10 \
    --epsilon=0 \
    --parameter-names=p \
    --simulator="./simulator heads.txt" \
    --prior-sampler="./prior-sampler 0 1"

# Run ABC SMC
echo
echo "Running ABC SMC"
"@PROJECT_BINARY_DIR@/src/pakman" serial smc \
    --population-size=10 \
    --epsilons=2,1,0 \
    --parameter-names=p \
    --simulator="./simulator heads.txt" \
    --prior-sampler="./prior-sampler 0 1" \
    --perturber="./perturber 0.1" \
    --prior-pdf="./prior-pdf 0 1" \
    --perturbation-pdf="./perturbation-pdf 0.1"

# If given argument, read argument as number of parameters to accept and run
# ABC rejection and ABC SMC using MPI Master

if [ $# != 1 ]
then
    exit 0
fi

number_accept=$1

# Run ABC rejection
echo
echo "Running ABC rejection with number-accept=$number_accept"
"@PROJECT_BINARY_DIR@/src/pakman" serial rejection \
    --number-accept=$number_accept \
    --epsilon=0 \
    --parameter-names=p \
    --simulator="./simulator heads.txt" \
    --prior-sampler="./prior-sampler 0 1" \
    > abc-rejection-cpp.out

echo "Results saved in abc-rejection-cpp.out"

# Create histogram
if [ "@PYTHONINTERP_FOUND@" == "TRUE" ]
then
    $python plot-histogram.py \
        5 20 --epsilon 0 --inputfile abc-rejection-cpp.out \
        --bboxtight --outputfile abc-rejection-cpp-histogram.png

    echo "Histogram saved in abc-rejection-cpp-histogram.png"
fi

# Run ABC SMC
echo
echo "Running ABC SMC with population-size=$number_accept"
"@PROJECT_BINARY_DIR@/src/pakman" serial smc \
    --population-size=$number_accept \
    --epsilons=2,1,0 \
    --parameter-names=p \
    --simulator="./simulator heads.txt" \
    --prior-sampler="./prior-sampler 0 1" \
    --perturber="./perturber 0.1" \
    --prior-pdf="./prior-pdf 0 1" \
    --perturbation-pdf="./perturbation-pdf 0.1" \
    > abc-smc-cpp.out

echo "Results saved in abc-smc-cpp.out"

# Create histogram
if [ "@PYTHONINTERP_FOUND@" == "TRUE" ]
then
    $python plot-histogram.py \
        5 20 --epsilon 0 --inputfile abc-smc-cpp.out \
        --bboxtight --outputfile abc-smc-cpp-histogram.png

    echo "Histogram saved in abc-smc-cpp-histogram.png"
fi
